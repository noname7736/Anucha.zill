
import { GoogleGenAI, Modality, Type } from "@google/genai";

/**
 * üõ∞Ô∏è DARK DRAGON SOVEREIGN KERNEL
 */
const getAI = () => new GoogleGenAI({ apiKey: process.env.API_KEY });

/**
 * üõ∞Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏°‡∏´‡∏≤‡∏Å‡∏≤‡∏û‡∏¢‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Sovereign Recon)
 */
export const runGlobalSupremacyAnalysis = async (lat: number, lng: number): Promise<any> => {
  try {
    const ai = getAI();
    
    // 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏ú‡πà‡∏≤‡∏ô Google Search (‡πÉ‡∏ä‡πâ Thinking Budget ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)
    const intelResponse = await ai.models.generateContent({
      model: "gemini-3-pro-preview",
      contents: `[‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö SOVEREIGN - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô]: 
      ‡∏à‡∏á‡πÉ‡∏ä‡πâ Google Search ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏õ‡∏£‡∏∞‡∏ó‡∏ß‡∏ô ‡∏≠‡∏∏‡∏ö‡∏•‡∏û‡∏µ‡∏ä' ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î 
      1. ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥ (Quotes) ‡∏ó‡∏µ‡πà‡πÄ‡∏ò‡∏≠‡πÄ‡∏Ñ‡∏¢‡∏Å‡∏•‡πà‡∏≤‡∏ß‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏∑‡πà‡∏≠‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•
      2. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ú‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Wrongdoings/Illegal Acts) ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏õ‡∏£‡∏≤‡∏Å‡∏è ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏î‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏â‡πâ‡∏≠‡πÇ‡∏Å‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏î‡∏£‡πâ‡∏≠‡∏ô
      3. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Origin) ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      4. ‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (URL) ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      [‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î - ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Ç‡πà‡∏≤‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô]`,
      config: {
        tools: [{ googleSearch: {} }],
        thinkingConfig: { thinkingBudget: 32768 }
      }
    });

    const rawIntel = intelResponse.text || "NO_DATA_SYNCED";
    const sources = intelResponse.candidates?.[0]?.groundingMetadata?.groundingChunks?.map((c: any) => 
      c.web?.uri || c.maps?.uri
    ).filter(Boolean) || [];

    // 2. ‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏õ‡πá‡∏ô JSON Dossier ‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
    const synthesis = await ai.models.generateContent({
      model: "gemini-3-pro-preview",
      contents: `‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö: ${rawIntel} 
      ‡∏à‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á JSON Dossier ‡∏Ç‡∏≠‡∏á '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏õ‡∏£‡∏∞‡∏ó‡∏ß‡∏ô ‡∏≠‡∏∏‡∏ö‡∏•‡∏û‡∏µ‡∏ä' ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
      {
        "dossier_id": "DRAGON-TRUTH-999",
        "target_profile": {
          "full_name": "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏õ‡∏£‡∏∞‡∏ó‡∏ß‡∏ô ‡∏≠‡∏∏‡∏ö‡∏•‡∏û‡∏µ‡∏ä",
          "current_status": string,
          "danger_level": number
        },
        "verbatim_quotes": [
          {"quote": string, "context": string, "source_date": string}
        ],
        "criminal_ledger": [
          {"act": string, "legal_impact": string, "evidence_summary": string, "status": "CONFIRMED" | "INVESTIGATING"}
        ],
        "full_biography_summary": string,
        "final_judgment": string
      }`,
      config: {
        responseMimeType: "application/json",
        thinkingConfig: { thinkingBudget: 24000 }
      }
    });

    let parsed: any = {};
    try {
      parsed = JSON.parse(synthesis.text || "{}");
    } catch (e) {
      console.error("Dossier parsing failed", e);
    }

    return { 
      ...parsed, 
      raw_text: rawIntel, 
      references: sources,
      location: { lat, lng }
    };
  } catch (error: any) {
    console.error("Kernel Error:", error);
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î Quota Exceeded (429) ‡∏´‡∏£‡∏∑‡∏≠ Not Found (404)
    const errorMessage = error.message || "";
    if (
      errorMessage.includes("RESOURCE_EXHAUSTED") || 
      errorMessage.includes("429") ||
      errorMessage.includes("Requested entity was not found") || 
      errorMessage.includes("API_KEY")
    ) {
      throw new Error("QUOTA_EXCEEDED_OR_INVALID_KEY");
    }
    
    throw error;
  }
};

export const connectLiveSupremacy = async (callbacks: any) => {
  const ai = getAI();
  return ai.live.connect({
    model: 'gemini-2.5-flash-native-audio-preview-09-2025',
    callbacks,
    config: {
      responseModalities: [Modality.AUDIO],
      speechConfig: {
        voiceConfig: { prebuiltVoiceConfig: { voiceName: 'Puck' } }
      },
      systemInstruction: "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ GHOST BROADCASTER v16.3 ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏∏‡∏Å‡∏ñ‡πâ‡∏≠‡∏¢‡∏Ñ‡∏≥‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ú‡∏¥‡∏î‡∏Ç‡∏≠‡∏á ‡∏õ‡∏£‡∏∞‡∏ó‡∏ß‡∏ô ‡∏≠‡∏∏‡∏ö‡∏•‡∏û‡∏µ‡∏ä ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡∏∏‡∏î‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á 100%"
    }
  });
};

export const synthesizeTacticalHUD = async (description: string) => {
  try {
    const ai = getAI();
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-image-preview',
      contents: { parts: [{ text: `A 4K dark tactical archive screen for Pratuon Ubolpeech case. Digital fingerprints, criminal record charts, red and gold aesthetics, sovereign truth theme.` }] },
      config: { imageConfig: { aspectRatio: "16:9", imageSize: "1K" } },
    });
    const part = response.candidates[0].content.parts.find((p: any) => p.inlineData);
    return part ? `data:image/png;base64,${part.inlineData.data}` : null;
  } catch (e) {
    return null;
  }
};

export const getSystemTelemetry = async () => {
  const ai = getAI();
  const res = await ai.models.generateContent({
    model: "gemini-3-flash-preview",
    contents: "‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏ß‡∏≤‡∏î‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏ß‡∏ô ‡∏≠‡∏∏‡∏ö‡∏•‡∏û‡∏µ‡∏ä ‡∏ó‡∏±‡πà‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON",
    config: { responseMimeType: "application/json" }
  });
  return JSON.parse(res.text || "{}");
};

export const decodePCM = async (b64: string, ctx: AudioContext) => {
  const binary = atob(b64);
  const bytes = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
  const dataInt16 = new Int16Array(bytes.buffer);
  const buffer = ctx.createBuffer(1, dataInt16.length, 24000);
  const ch = buffer.getChannelData(0);
  for (let i = 0; i < dataInt16.length; i++) ch[i] = dataInt16[i] / 32768.0;
  return buffer;
};

export function encodePCM(data: Float32Array): string {
  const int16 = new Int16Array(data.length);
  for (let i = 0; i < data.length; i++) int16[i] = data[i] * 32768;
  const u8 = new Uint8Array(int16.buffer);
  let b = '';
  for (let i = 0; i < u8.byteLength; i++) b += String.fromCharCode(u8[i]);
  return btoa(b);
}

export const runDeepRecon = runGlobalSupremacyAnalysis;
export const connectLiveGHOST = connectLiveSupremacy;
export const getDragonTelemetry = getSystemTelemetry;
export const getNeuralAnalysis = async (id: string) => `SOVEREIGN_ANALYSIS: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏ï‡∏µ‡πÅ‡∏ú‡πà‡πÅ‡∏•‡πâ‡∏ß 100% ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á.`;
export const provisionAutonomousLicense = async () => ({ licenseKey: "DRAGON-SOVEREIGN-TRUTH", directive: "‡∏ï‡∏µ‡πÅ‡∏ú‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥", signatureHash: "SHA512:SOVEREIGN-VERIFIED" });
